<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dmp_lib.movement_primitives &mdash; dmp_lib 1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> dmp_lib
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">dmp_lib</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">dmp_lib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>dmp_lib.movement_primitives</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dmp_lib.movement_primitives</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.matlib</span> <span class="k">as</span> <span class="nn">matlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span> <span class="k">as</span> <span class="nn">interpolate</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">savgol_filter</span>
<span class="kn">from</span> <span class="nn">dmp_lib.transformation</span> <span class="kn">import</span> <span class="n">Transformation</span>
<span class="kn">from</span> <span class="nn">dmp_lib.canonical</span> <span class="kn">import</span> <span class="n">Canonical</span>
<span class="kn">from</span> <span class="nn">dmp_lib.goal</span> <span class="kn">import</span> <span class="n">Goal</span>
<span class="kn">from</span> <span class="nn">dmp_lib.geometry</span> <span class="kn">import</span> <span class="n">quat_to_rot</span>
<span class="kn">from</span> <span class="nn">dmp_lib.geometry</span> <span class="kn">import</span> <span class="n">rot_to_quat</span>
<span class="kn">from</span> <span class="nn">dmp_lib.geometry</span> <span class="kn">import</span> <span class="n">rot_to_axis_angle</span>
<span class="kn">from</span> <span class="nn">dmp_lib.geometry</span> <span class="kn">import</span> <span class="n">axis_angle_to_rot</span>
<span class="kn">from</span> <span class="nn">dmp_lib.geometry</span> <span class="kn">import</span> <span class="n">axis_angle_to_quat</span>
<span class="kn">from</span> <span class="nn">dmp_lib.geometry</span> <span class="kn">import</span> <span class="n">quat_to_axis_angle</span>
<span class="kn">from</span> <span class="nn">dmp_lib.geometry</span> <span class="kn">import</span> <span class="n">solve_discontinuities</span>
<span class="kn">from</span> <span class="nn">dmp_lib.geometry</span> <span class="kn">import</span> <span class="n">is_rotation_matrix</span>


<div class="viewcode-block" id="DMP"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP">[docs]</a><span class="k">class</span> <span class="nc">DMP</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class used to implement the DMP comprising of a canonical, goal </span>
<span class="sd">    and transformation system working together.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    canonical_sys : dmp_lib.canonical.Canonical</span>
<span class="sd">        canonical system</span>

<span class="sd">    goal_sys : dmp_lib.goal.Goal</span>
<span class="sd">        goal system</span>

<span class="sd">    transformation_sys : dmp_lib.transformation.Transformation</span>
<span class="sd">        transformation system</span>

<span class="sd">    z : numpy.ndarray</span>
<span class="sd">        scaled velocity variable</span>

<span class="sd">    x0 : numpy.ndarray</span>
<span class="sd">        initial state</span>

<span class="sd">    sys_dim: int</span>
<span class="sd">        system dimension</span>

<span class="sd">    tau : float</span>
<span class="sd">        time scaling parameter</span>

<span class="sd">    dt : float</span>
<span class="sd">        sampling interval</span>

<span class="sd">    num_basis : int</span>
<span class="sd">        number of basis functions</span>

<span class="sd">    centers: numpy.ndarray</span>
<span class="sd">        basis function centers</span>

<span class="sd">    widths: numpy.ndarray</span>
<span class="sd">        basis function widths</span>

<span class="sd">    weights: numpy.ndarray</span>
<span class="sd">        basis function weights</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_basis</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">g0</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span>
                 <span class="n">alpha_phase</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">alpha_stop</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="n">alpha_g</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> 
                 <span class="n">K</span> <span class="o">=</span> <span class="mi">25</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;advanced&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_basis : int</span>
<span class="sd">            number of basis functions</span>

<span class="sd">        x0 : numpy.ndarray</span>
<span class="sd">            initial state</span>

<span class="sd">        g0 : numpy.ndarray</span>
<span class="sd">            goal state</span>

<span class="sd">        dt : float</span>
<span class="sd">            sampling time</span>

<span class="sd">        tau : float</span>
<span class="sd">            time scaling parameter</span>

<span class="sd">        alpha_phase : float, optional</span>
<span class="sd">            phase decay parameter (default is 25 / 3)</span>

<span class="sd">        alpha_stop : float, optional</span>
<span class="sd">            phase stop parameter (default is 0)</span>

<span class="sd">        alpha_g : float, optional</span>
<span class="sd">            goal advancement parameter (default is 25 / 2)</span>

<span class="sd">        K : float, optional</span>
<span class="sd">            stiffness parameter (default is 25**2 / 2)</span>

<span class="sd">        D : float, optional</span>
<span class="sd">            damping parameter (default is None -&gt; D = 2 * sqrt(K))</span>

<span class="sd">        style: string, optional</span>
<span class="sd">            dynamics style (default is &#39;advanced&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">x0</span><span class="p">):</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">g0</span><span class="p">):</span>
            <span class="n">g0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">g0</span><span class="p">])</span>

        <span class="c1"># save system dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">size</span>

        <span class="c1"># init canonical system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span> <span class="o">=</span> <span class="n">Canonical</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">alpha_phase</span><span class="p">,</span> <span class="n">alpha_stop</span><span class="p">)</span>

        <span class="c1"># init goal system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal_sys</span> <span class="o">=</span> <span class="n">Goal</span><span class="p">(</span><span class="n">g0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">alpha_g</span><span class="p">)</span>

        <span class="c1"># init transformation system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span> <span class="o">=</span> <span class="n">Transformation</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_basis</span> <span class="o">=</span> <span class="n">num_basis</span>

        <span class="c1"># init forcing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_forcing</span><span class="p">(</span><span class="n">num_basis</span><span class="p">)</span>


<div class="viewcode-block" id="DMP.init_forcing"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.init_forcing">[docs]</a>    <span class="k">def</span> <span class="nf">init_forcing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_basis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize parameters of the forcing term.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_basis : int</span>
<span class="sd">            number of basis functions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_basis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_basis</span><span class="p">,</span> <span class="bp">self</span> <span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_basis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>

        <span class="c1"># compute Gaussian centers</span>
        <span class="n">c_locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span><span class="o">.</span><span class="n">alpha_phase</span> <span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_basis</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_basis</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">centers</span> <span class="o">=</span> \
            <span class="n">matlib</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">c_locations</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">)</span>

        <span class="c1"># compute Gaussian widths</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_basis</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">widths</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centers</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">centers</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">widths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">widths</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,:]</span></div>


<div class="viewcode-block" id="DMP.evaluate_basis"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.evaluate_basis">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluate basis functions at phase s.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        s : float</span>
<span class="sd">            phase location</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            basis functions values in s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">widths</span><span class="o">*</span><span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">centers</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="DMP.evaluate_forcing"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.evaluate_forcing">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_forcing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluate forcing term at phase s.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        s : float</span>
<span class="sd">            phase location</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            forcing term in s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_phi_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_basis</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_phi_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">den</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_phi_s</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">den</span><span class="o">*</span><span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span></div>


<div class="viewcode-block" id="DMP.evaluate_weighted_basis"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.evaluate_weighted_basis">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_weighted_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluate weighted basis functions at phase s.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        s : float</span>
<span class="sd">            phase location</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            weighted sum of basis functions values in s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_phi_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_basis</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_phi_s</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span></div>


<div class="viewcode-block" id="DMP.reset"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset DMP at initial state x0.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x0 : numpy.ndarray</span>
<span class="sd">            initial state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">x0</span><span class="p">):</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span> <span class="c1"># reset phase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span> <span class="c1"># reset transformation system</span></div>


<div class="viewcode-block" id="DMP.set_tau"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.set_tau">[docs]</a>    <span class="k">def</span> <span class="nf">set_tau</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_tau</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set time scaling parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_tau: float</span>
<span class="sd">            new time scaling parameter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">new_tau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">new_tau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">new_tau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal_sys</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">new_tau</span></div>


<div class="viewcode-block" id="DMP.set_new_goal"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.set_new_goal">[docs]</a>    <span class="k">def</span> <span class="nf">set_new_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_g</span><span class="p">,</span> <span class="n">force_goal</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set new desired goal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_g : numpy.ndarray</span>
<span class="sd">            new goal </span>

<span class="sd">        force_goal : bool, optional</span>
<span class="sd">            choose if override g variable or only g0 (default is True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal_sys</span><span class="o">.</span><span class="n">set_new_goal</span><span class="p">(</span><span class="n">new_g</span><span class="p">,</span> <span class="n">force_goal</span><span class="o">=</span><span class="n">force_goal</span><span class="p">)</span> <span class="c1"># update goal system</span></div>


<div class="viewcode-block" id="DMP.get_phase"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.get_phase">[docs]</a>    <span class="k">def</span> <span class="nf">get_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get current phase from canonical system.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            phase value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span><span class="o">.</span><span class="n">get_phase</span><span class="p">()</span></div>


<div class="viewcode-block" id="DMP.get_goal"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.get_goal">[docs]</a>    <span class="k">def</span> <span class="nf">get_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get current goal from goal system.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            goal value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal_sys</span><span class="o">.</span><span class="n">get_goal</span><span class="p">()</span></div>


<div class="viewcode-block" id="DMP.get_output"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.get_output">[docs]</a>    <span class="k">def</span> <span class="nf">get_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get DMP output from transformation system.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            a list with current DMP position and velocity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span></div>


<div class="viewcode-block" id="DMP.step"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.step">[docs]</a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Single-step DMP update.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dist : float</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_phase</span><span class="p">()</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_goal</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_forcing</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal_sys</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span></div>


<div class="viewcode-block" id="DMP.learn_from_demo"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.learn_from_demo">[docs]</a>    <span class="k">def</span> <span class="nf">learn_from_demo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_demo</span><span class="p">,</span> <span class="n">time_steps</span><span class="p">,</span> <span class="n">filter_mode</span> <span class="o">=</span> <span class="s1">&#39;savgol&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit forcing function to reproduce desired trajectory.</span>

<span class="sd">           Attributes tau, x0, g0 are modified according to demo.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_demo : numpy.ndarray</span>
<span class="sd">            demo trajectory [x_demo.shape : (num_steps, sys_dim)]</span>

<span class="sd">        time_steps : numpy.ndarray</span>
<span class="sd">            time steps [time_steps.shape : (num_steps,)]</span>

<span class="sd">        filter_mode : string, optional</span>
<span class="sd">            either &#39;savgol&#39; or &#39;cd&#39; (default is &#39;savgol&#39;)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list with (processed) x_demo, dx_demo, ddx_demo, time_steps</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if x_demo and time_steps have different length</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_demo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_demo</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>
        <span class="n">time_steps</span> <span class="o">=</span> <span class="n">time_steps</span><span class="o">-</span><span class="n">time_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># initial time to 0 sec</span>

        <span class="k">if</span> <span class="n">x_demo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">time_steps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x_demo and time_steps must have the same length&quot;</span><span class="p">)</span>

        <span class="c1"># interpolate demo</span>
        <span class="n">path_gen</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span> <span class="n">x_demo</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="c1"># use constant sampling intervals</span>
        <span class="n">time_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">time_steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
                
        <span class="n">num_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">)</span>

        <span class="c1"># modiffy tau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_tau</span><span class="p">(</span><span class="n">num_steps</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

        <span class="n">x_demo</span> <span class="o">=</span> <span class="n">path_gen</span><span class="p">(</span><span class="n">time_steps</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="k">if</span> <span class="n">filter_mode</span> <span class="o">==</span> <span class="s1">&#39;savgol&#39;</span><span class="p">:</span>
            <span class="c1"># compute derivatives with Savitzky-Golay filter</span>
            <span class="n">x_demo</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">x_demo</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
            <span class="n">dx_demo</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">x_demo</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                                    <span class="n">deriv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">ddx_demo</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">x_demo</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                                     <span class="n">deriv</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">filter_mode</span> <span class="o">==</span> <span class="s1">&#39;cd&#39;</span><span class="p">:</span>
            <span class="n">dx_demo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x_demo</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">ddx_demo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x_demo</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="c1"># compute derivatives with central difference</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">):</span>
                <span class="n">dx_demo</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">x_demo</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">time_steps</span><span class="p">)</span>
                <span class="n">ddx_demo</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">dx_demo</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">time_steps</span><span class="p">)</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">x_demo</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>

        <span class="c1"># compute phase values</span>
        <span class="n">s_demo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_steps</span><span class="p">)</span>
        <span class="n">s_demo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span><span class="o">.</span><span class="n">get_phase</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">time_steps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">time_steps</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">s_demo</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span><span class="o">.</span><span class="n">get_phase</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>       

        <span class="c1"># get forcing term weights for each system dimension</span>
        <span class="n">f_d_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">):</span>
            <span class="c1"># compute desired forcing term</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;advanced&#39;</span><span class="p">:</span>
                <span class="n">f_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ddx_demo</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">K</span> \
                    <span class="o">-</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_demo</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> \
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">D</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">K</span> \
                    <span class="o">*</span><span class="n">dx_demo</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_demo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">s_demo</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;classic&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="n">x_demo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">f_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x_demo</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f_d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ddx_demo</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">K</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_demo</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">D</span> <span class="o">*</span> \
                        <span class="n">dx_demo</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_demo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>  
            <span class="n">f_d_all</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">f_d</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">):</span>
            <span class="n">f_d</span> <span class="o">=</span> <span class="n">f_d_all</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span>
            <span class="c1"># get regressor matrix</span>
            <span class="n">Phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_basis</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
                <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_basis</span><span class="p">(</span><span class="n">s_demo</span><span class="p">[</span><span class="n">k</span><span class="p">])[:,</span><span class="n">j</span><span class="p">]</span> 
                <span class="n">Phi</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">basis</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span><span class="o">*</span><span class="n">s_demo</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="c1"># Solve: Phi * w = f_d</span>
            <span class="n">fitted_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">Phi</span><span class="p">),</span> <span class="n">f_d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitted_w</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>


        <span class="k">return</span> <span class="n">x_demo</span><span class="p">,</span> <span class="n">dx_demo</span><span class="p">,</span> <span class="n">ddx_demo</span><span class="p">,</span> <span class="n">time_steps</span></div>


<div class="viewcode-block" id="DMP.get_weights"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.get_weights">[docs]</a>    <span class="k">def</span> <span class="nf">get_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get DMP weights.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            basis functions weights</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span></div>


<div class="viewcode-block" id="DMP.import_weights"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.import_weights">[docs]</a>    <span class="k">def</span> <span class="nf">import_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_weights</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Import DMP weights.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_weights : numpy.ndarray</span>
<span class="sd">            new DMP weights [new_weights.shape = (num_basis, sys_dim)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_weights</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">new_weights</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Weights dimensions not valid&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DMP.rollout"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.rollout">[docs]</a>    <span class="k">def</span> <span class="nf">rollout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run a DMP rollout and reset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list of numpy.array describing the rollout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

        <span class="n">g0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_goal</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>

        <span class="n">forcing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_steps</span><span class="p">):</span>
            <span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_phase</span><span class="p">()</span>
            <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">,:],</span> <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>
            <span class="n">g</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_goal</span><span class="p">()</span>
            <span class="n">forcing</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_forcing</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">time_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">forcing</span><span class="p">,</span> <span class="n">s</span></div>

<div class="viewcode-block" id="DMP.info"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.DMP.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return info about DMP type.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        string</span>
<span class="sd">            DMP type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;single&#39;</span></div></div>


<div class="viewcode-block" id="Bimanual_DMP"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Bimanual_DMP">[docs]</a><span class="k">class</span> <span class="nc">Bimanual_DMP</span><span class="p">(</span><span class="n">DMP</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class used to implement the Bimanual DMP that controls a virtual </span>
<span class="sd">    frame placed between the two end-effectors. Each end-effector pose </span>
<span class="sd">    is defined by a fixed rotation and variable translation from the </span>
<span class="sd">    central virtual frame. Bimanual_DMP extends the main DMP class.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    canonical_sys : dmp_lib.canonical.Canonical</span>
<span class="sd">        canonical system</span>

<span class="sd">    goal_sys : dmp_lib.goal.Goal</span>
<span class="sd">        goal system</span>

<span class="sd">    transformation_sys : dmp_lib.transformation.Transformation</span>
<span class="sd">        transformation system</span>

<span class="sd">    z : numpy.ndarray</span>
<span class="sd">        scaled velocity variable</span>

<span class="sd">    x0 : numpy.ndarray</span>
<span class="sd">        initial state</span>

<span class="sd">    sys_dim: int</span>
<span class="sd">        system dimension</span>

<span class="sd">    tau : float</span>
<span class="sd">        time scaling parameter</span>

<span class="sd">    dt : float</span>
<span class="sd">        sampling interval</span>

<span class="sd">    num_basis : int</span>
<span class="sd">        number of basis functions</span>

<span class="sd">    centers: numpy.ndarray</span>
<span class="sd">        basis function centers</span>

<span class="sd">    widths: numpy.ndarray</span>
<span class="sd">        basis function widths</span>

<span class="sd">    weights: numpy.ndarray</span>
<span class="sd">        basis function weights</span>

<span class="sd">    R_right : numpy.ndarray</span>
<span class="sd">        right EE rotation matrix [R_right.shape = (3,3)]</span>

<span class="sd">    R_left : numpy.ndarray</span>
<span class="sd">        left EE rotation matrix [R_left.shape = (3,3)]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_basis</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">g0</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span>
                 <span class="n">alpha_phase</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">alpha_stop</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="n">alpha_g</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                 <span class="n">K</span> <span class="o">=</span> <span class="mi">25</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;advanced&#39;</span><span class="p">,</span>
                 <span class="n">R_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">R_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_basis : int</span>
<span class="sd">            number of basis functions</span>

<span class="sd">        x0 : numpy.ndarray</span>
<span class="sd">            initial state</span>

<span class="sd">        g0 : numpy.ndarray</span>
<span class="sd">            goal state</span>

<span class="sd">        dt : float</span>
<span class="sd">            sampling time</span>

<span class="sd">        tau : float</span>
<span class="sd">            time scaling parameter</span>

<span class="sd">        alpha_phase : float, optional</span>
<span class="sd">            phase decay parameter (default is 25 / 3)</span>

<span class="sd">        alpha_stop : float, optional</span>
<span class="sd">            phase stop parameter (default is 0)</span>

<span class="sd">        alpha_g : float, optional</span>
<span class="sd">            goal advancement parameter (default is 25 / 2)</span>

<span class="sd">        K : float, optional</span>
<span class="sd">            stiffness parameter (default is 25**2 / 2)</span>

<span class="sd">        D : float, optional</span>
<span class="sd">            damping parameter (default is None -&gt; D = 2 * sqrt(K))</span>

<span class="sd">        style: string, optional</span>
<span class="sd">            dynamics style (default is &#39;advanced&#39;)</span>

<span class="sd">        R_right: numpy.ndarray, optional</span>
<span class="sd">            right EE rotation matrix (default is np.eye(3))</span>

<span class="sd">        R_left: numpy.ndarray, optional</span>
<span class="sd">            left EE rotation matrix (default is np.eye(3))</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if R_right or R_left are not proper rotation matrices</span>
<span class="sd">            if len(x0) is less than 7 (virtual frame prose + distance)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">x0</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;len(x0) must be at least 7 </span><span class="se">\</span>
<span class="s1">                (virtual frame prose + distance)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_rotation_matrix</span><span class="p">(</span><span class="n">R_right</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;R_right is not a rotation matrix&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_rotation_matrix</span><span class="p">(</span><span class="n">R_left</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;R_left is not a rotation matrix&#39;</span><span class="p">)</span>

        <span class="n">DMP</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">num_basis</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">g0</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span>
            <span class="n">alpha_phase</span><span class="p">,</span> <span class="n">alpha_stop</span><span class="p">,</span> <span class="n">alpha_g</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">R_right</span> <span class="o">=</span> <span class="n">R_right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_left</span> <span class="o">=</span> <span class="n">R_left</span>


<div class="viewcode-block" id="Bimanual_DMP.get_poses"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Bimanual_DMP.get_poses">[docs]</a>    <span class="k">def</span> <span class="nf">get_poses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get end-effector positions from virtual frame pose.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list with left and right positions and quaternions </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># DMP state: virtual frame pose &amp; distance (+ other components not used here)</span>
        <span class="n">x</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>

        <span class="n">vf_position</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">vf_axis_angle</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">vf_R</span> <span class="o">=</span> <span class="n">axis_angle_to_rot</span><span class="p">(</span><span class="n">vf_axis_angle</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>

        <span class="c1"># world-to-virtual-frame</span>
        <span class="n">H_vf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">H_vf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">vf_R</span>
        <span class="n">H_vf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">vf_position</span>
        <span class="n">H_vf</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># virtual-frame-to-right</span>
        <span class="n">vf_H_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">vf_H_r</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_right</span>
        <span class="n">vf_H_r</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">dist</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">vf_H_r</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># virtual-frame-to-left</span>
        <span class="n">vf_H_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">vf_H_l</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_left</span>
        <span class="n">vf_H_l</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">dist</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">vf_H_l</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># compose transformations</span>
        <span class="n">H_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">H_vf</span><span class="p">,</span> <span class="n">vf_H_r</span><span class="p">)</span>
        <span class="n">H_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">H_vf</span><span class="p">,</span> <span class="n">vf_H_l</span><span class="p">)</span>

        <span class="n">R_r</span> <span class="o">=</span> <span class="n">H_r</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">q_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot_to_quat</span><span class="p">(</span><span class="n">R_r</span><span class="p">))</span>
        <span class="n">p_r</span> <span class="o">=</span> <span class="n">H_r</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">R_l</span> <span class="o">=</span> <span class="n">H_l</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">q_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot_to_quat</span><span class="p">(</span><span class="n">R_l</span><span class="p">))</span>
        <span class="n">p_l</span> <span class="o">=</span> <span class="n">H_l</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">p_r</span><span class="p">,</span> <span class="n">q_r</span><span class="p">,</span> <span class="n">p_l</span><span class="p">,</span> <span class="n">q_l</span></div>


<div class="viewcode-block" id="Bimanual_DMP.rollout"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Bimanual_DMP.rollout">[docs]</a>    <span class="k">def</span> <span class="nf">rollout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run a DMP rollout and reset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list of numpy.array describing the bimanual rollout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        
        <span class="n">g0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_goal</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>

        <span class="n">forcing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>

        <span class="n">p_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">q_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">p_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">q_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_steps</span><span class="p">):</span>
            <span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_phase</span><span class="p">()</span>
            <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">,:],</span> <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>
            <span class="n">g</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_goal</span><span class="p">()</span>
            <span class="n">forcing</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_forcing</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">p_r</span><span class="p">[</span><span class="n">k</span><span class="p">,:],</span> <span class="n">q_r</span><span class="p">[</span><span class="n">k</span><span class="p">,:],</span> <span class="n">p_l</span><span class="p">[</span><span class="n">k</span><span class="p">,:],</span> <span class="n">q_l</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_poses</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">time_steps</span><span class="p">,</span> <span class="n">p_r</span><span class="p">,</span> <span class="n">q_r</span><span class="p">,</span> <span class="n">p_l</span><span class="p">,</span> <span class="n">q_l</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">forcing</span><span class="p">,</span> <span class="n">s</span></div>

<div class="viewcode-block" id="Bimanual_DMP.info"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Bimanual_DMP.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return info about DMP type.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        string</span>
<span class="sd">            DMP type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;dual&#39;</span></div></div>



<div class="viewcode-block" id="Target_DMP"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Target_DMP">[docs]</a><span class="k">class</span> <span class="nc">Target_DMP</span><span class="p">(</span><span class="n">DMP</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Target-Referred DMP subclass (extension of DMP).</span>
<span class="sd">    A class used to implement the Target-Referred DMP (TR-DMP) that</span>
<span class="sd">    learned demo trajectory w.r.t. a target reference frame that can</span>
<span class="sd">    be changed at execution time.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    canonical_sys : dmp_lib.canonical.Canonical</span>
<span class="sd">        canonical system</span>
<span class="sd">    goal_sys : dmp_lib.goal.Goal</span>
<span class="sd">        goal system</span>
<span class="sd">    transformation_sys : dmp_lib.transformation.Transformation</span>
<span class="sd">        transformation system</span>
<span class="sd">    z : numpy.ndarray</span>
<span class="sd">        scaled velocity variable</span>
<span class="sd">    x0 : numpy.ndarray</span>
<span class="sd">        initial state</span>
<span class="sd">    sys_dim: int</span>
<span class="sd">        system dimension</span>
<span class="sd">    tau : float</span>
<span class="sd">        time scaling parameter</span>
<span class="sd">    dt : float</span>
<span class="sd">        sampling interval</span>
<span class="sd">    num_basis : int</span>
<span class="sd">        number of basis functions</span>
<span class="sd">    centers: numpy.ndarray</span>
<span class="sd">        basis function centers</span>
<span class="sd">    widths: numpy.ndarray</span>
<span class="sd">        basis function widths</span>
<span class="sd">    weights: numpy.ndarray</span>
<span class="sd">        basis function weights</span>
<span class="sd">    w_H_t: numpy.ndarray</span>
<span class="sd">        world-to-target homogeneous transformation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_basis</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">g0</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span>
                 <span class="n">alpha_phase</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">alpha_stop</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="n">alpha_g</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> 
                 <span class="n">K</span> <span class="o">=</span> <span class="mi">25</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;advanced&#39;</span><span class="p">,</span>
                 <span class="n">w_H_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_basis : int</span>
<span class="sd">            number of basis functions</span>

<span class="sd">        x0 : numpy.ndarray</span>
<span class="sd">            initial state</span>

<span class="sd">        g0 : numpy.ndarray</span>
<span class="sd">            goal state</span>

<span class="sd">        tau : float</span>
<span class="sd">            time scaling parameter</span>

<span class="sd">        dt : float</span>
<span class="sd">            sampling time</span>

<span class="sd">        alpha_phase : float, optional</span>
<span class="sd">            phase decay parameter (default is 25 / 3)</span>

<span class="sd">        alpha_stop : float, optional</span>
<span class="sd">            phase stop parameter (default is 0)</span>

<span class="sd">        alpha_g : float, optional</span>
<span class="sd">            goal advancement parameter (default is 25 / 2)</span>

<span class="sd">        K : float, optional</span>
<span class="sd">            stiffness parameter (default is 25**2 / 2)</span>

<span class="sd">        D : float, optional</span>
<span class="sd">            damping parameter (default is None -&gt; D = 2 * sqrt(K))</span>

<span class="sd">        style: string, optional</span>
<span class="sd">            dynamics style (default is &#39;advanced&#39;)</span>

<span class="sd">        w_H_t: numpy.ndarray, optional</span>
<span class="sd">            world-to-target hom. transformation (default is np.eye(4))</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if w_H_t is not a proper homogeneous transformation matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">x0</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;x0 must represent a 6D end-effector pose&#39;</span><span class="p">)</span>

        <span class="n">DMP</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_basis</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">g0</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span>
            <span class="n">alpha_phase</span><span class="p">,</span> <span class="n">alpha_stop</span><span class="p">,</span> <span class="n">alpha_g</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">w_H_t</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_rotation_matrix</span><span class="p">(</span><span class="n">w_H_t</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">w_H_t</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">w_H_t</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">w_H_t</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.</span> 
                    <span class="ow">and</span> <span class="n">w_H_t</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span> 
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;w_H_t is not a proper </span><span class="se">\</span>
<span class="s1">                        homogeneous transformation matrix&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_H_t</span> <span class="o">=</span> <span class="n">w_H_t</span>

<div class="viewcode-block" id="Target_DMP.learn_from_demo"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Target_DMP.learn_from_demo">[docs]</a>    <span class="k">def</span> <span class="nf">learn_from_demo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_demo</span><span class="p">,</span> <span class="n">time_steps</span><span class="p">,</span> <span class="n">filter_mode</span> <span class="o">=</span> <span class="s1">&#39;cd&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit forcing function to reproduce desired trajectory.</span>

<span class="sd">           Attributes tau, x0, g0 are modified according to demo.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_demo : numpy.ndarray</span>
<span class="sd">            demo trajectory [x_demo.shape : (num_steps, sys_dim)]</span>

<span class="sd">        time_steps : numpy.ndarray</span>
<span class="sd">            time steps [time_steps.shape : (num_steps,)]</span>

<span class="sd">        filter_mode : string, optional</span>
<span class="sd">            either &#39;savgol&#39; or &#39;cd&#39; (default is &#39;savgol&#39;)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list with (processed) x_demo, dx_demo, ddx_demo, time_steps</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if x_demo and time_steps have different length</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_demo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_demo</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>
        <span class="n">time_steps</span> <span class="o">=</span> <span class="n">time_steps</span><span class="o">-</span><span class="n">time_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># initial time to 0 sec</span>

        <span class="c1"># interpolate demo</span>
        <span class="n">path_gen</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span> <span class="n">x_demo</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># use constant sampling intervals</span>
        <span class="n">time_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">time_steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        
        <span class="n">num_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">)</span>

        <span class="c1"># set tau equal to demo time length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_tau</span><span class="p">(</span><span class="n">num_steps</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

        <span class="n">x_demo</span> <span class="o">=</span> <span class="n">path_gen</span><span class="p">(</span><span class="n">time_steps</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># get demo in target reference frame</span>
        <span class="n">axis_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">angle_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_demo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>       

            <span class="n">w_position_ee</span> <span class="o">=</span> <span class="n">x_demo</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">w_axis_angle_ee</span> <span class="o">=</span> <span class="n">x_demo</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
            <span class="n">w_R_ee</span> <span class="o">=</span> <span class="n">axis_angle_to_rot</span><span class="p">(</span><span class="n">w_axis_angle_ee</span><span class="p">)</span>  

            <span class="c1"># world-to-end-effector</span>
            <span class="n">w_H_ee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">w_H_ee</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_R_ee</span>
            <span class="n">w_H_ee</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_position_ee</span>
            <span class="n">w_H_ee</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="c1"># target-to-end-effector</span>
            <span class="n">t_H_ee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_H_t</span><span class="p">),</span> <span class="n">w_H_ee</span><span class="p">)</span>
            <span class="n">t_R_ee</span> <span class="o">=</span> <span class="n">t_H_ee</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">axis</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">rot_to_axis_angle</span><span class="p">(</span><span class="n">t_R_ee</span><span class="p">,</span> <span class="n">auto_align</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
            <span class="n">axis_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
            <span class="n">angle_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">t_axis_angle_ee</span> <span class="o">=</span> <span class="n">axis</span> <span class="o">*</span> <span class="n">angle</span>
            <span class="n">t_position_ee</span> <span class="o">=</span> <span class="n">t_H_ee</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">x_demo</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_position_ee</span>
            <span class="n">x_demo</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_axis_angle_ee</span>

        <span class="c1"># solve discontinuities</span>
        <span class="n">axis_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axis_list</span><span class="p">)</span>
        <span class="n">angle_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angle_list</span><span class="p">)</span>
        <span class="p">[</span><span class="n">axis</span><span class="p">,</span> <span class="n">angle</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve_discontinuities</span><span class="p">(</span><span class="n">axis_list</span><span class="p">,</span> <span class="n">angle_list</span><span class="p">,</span>
                                              <span class="n">flg_plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">axis_angle</span> <span class="o">=</span> <span class="n">matlib</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">axis</span>

        <span class="n">x_demo</span><span class="p">[:,</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis_angle</span>


        <span class="k">if</span> <span class="n">filter_mode</span> <span class="o">==</span> <span class="s1">&#39;savgol&#39;</span><span class="p">:</span>
            <span class="c1"># compute derivatives with Savitzky-Golay filter</span>
            <span class="n">x_demo</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">x_demo</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
            <span class="n">dx_demo</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">x_demo</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                                    <span class="n">deriv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">ddx_demo</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">x_demo</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                                     <span class="n">deriv</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">filter_mode</span> <span class="o">==</span> <span class="s1">&#39;cd&#39;</span><span class="p">:</span>
            <span class="n">dx_demo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x_demo</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">ddx_demo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x_demo</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="c1"># compute derivatives with central difference</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                <span class="n">dx_demo</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">x_demo</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">time_steps</span><span class="p">)</span>
                <span class="n">ddx_demo</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">dx_demo</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">time_steps</span><span class="p">)</span>

        <span class="c1"># set new goal</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">x_demo</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>

        <span class="c1"># compute phase values</span>
        <span class="n">s_demo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_steps</span><span class="p">)</span>
        <span class="n">s_demo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span><span class="o">.</span><span class="n">get_phase</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_steps</span><span class="p">):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">time_steps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">time_steps</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">s_demo</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span><span class="o">.</span><span class="n">get_phase</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>       

        <span class="c1"># get forcing term weights for each system dimension</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">):</span>
            <span class="c1"># compute desired forcing term</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;advanced&#39;</span><span class="p">:</span>
                <span class="n">f_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ddx_demo</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">K</span> <span class="o">-</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_demo</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">D</span> <span class="o">/</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">K</span> <span class="o">*</span> <span class="n">dx_demo</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_demo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">s_demo</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;classic&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="n">x_demo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">f_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x_demo</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f_d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ddx_demo</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">K</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_demo</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">D</span> <span class="o">*</span> <span class="n">dx_demo</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> \
                        <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_demo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>  
            
            <span class="n">f_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">f_d</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># get regressor matrix</span>
            <span class="n">Phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_basis</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
                <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_basis</span><span class="p">(</span><span class="n">s_demo</span><span class="p">[</span><span class="n">k</span><span class="p">])[:,</span><span class="n">j</span><span class="p">]</span> 
                <span class="n">Phi</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">basis</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span> <span class="o">*</span> <span class="n">s_demo</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="c1"># Solve: Phi * w = f_d</span>
            <span class="n">fitted_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">Phi</span><span class="p">),</span> <span class="n">f_d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitted_w</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">x_demo</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">in_world_frame</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_new_goal</span><span class="p">(</span><span class="n">x_demo</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">in_world_frame</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x_demo</span><span class="p">,</span> <span class="n">dx_demo</span><span class="p">,</span> <span class="n">ddx_demo</span><span class="p">,</span> <span class="n">time_steps</span></div>


<div class="viewcode-block" id="Target_DMP.get_pose"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Target_DMP.get_pose">[docs]</a>    <span class="k">def</span> <span class="nf">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get end-effector pose w.r.t. world frame</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list with EE position and quaternion (in world-frame) </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># DMP state: EE pose w.r.t. target frame</span>
        <span class="n">x</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>

        <span class="n">t_position_ee</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">t_axis_angle_ee</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">t_R_ee</span> <span class="o">=</span> <span class="n">axis_angle_to_rot</span><span class="p">(</span><span class="n">t_axis_angle_ee</span><span class="p">)</span>  

        <span class="c1"># target-to-end-effector</span>
        <span class="n">t_H_ee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">t_H_ee</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_R_ee</span>
        <span class="n">t_H_ee</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_position_ee</span>
        <span class="n">t_H_ee</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># compose transformations</span>
        <span class="n">w_H_ee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_H_t</span><span class="p">,</span> <span class="n">t_H_ee</span><span class="p">)</span>

        <span class="c1"># get EE frames in world coordinates</span>
        <span class="n">w_R_ee</span> <span class="o">=</span> <span class="n">w_H_ee</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># get position</span>
        <span class="n">w_p_ee</span> <span class="o">=</span> <span class="n">w_H_ee</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> 

        <span class="c1"># get orientation (as quaternion)</span>
        <span class="n">w_q_ee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot_to_quat</span><span class="p">(</span><span class="n">w_R_ee</span><span class="p">))</span>

        <span class="c1">## get orientation (as axis-angle)</span>
        <span class="c1"># axis, angle = rot_to_axis_angle(w_R_ee, auto_align = True)</span>
        <span class="c1"># w_aa_ee = axis * angle</span>

        <span class="k">return</span> <span class="n">w_p_ee</span><span class="p">,</span> <span class="n">w_q_ee</span></div>


<div class="viewcode-block" id="Target_DMP.rollout"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Target_DMP.rollout">[docs]</a>    <span class="k">def</span> <span class="nf">rollout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run a DMP rollout and reset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list of numpy.array describing the rollout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        
        <span class="n">g0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_goal</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>

        <span class="n">forcing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>

        <span class="n">w_p_ee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">w_q_ee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_steps</span><span class="p">):</span>
            <span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_phase</span><span class="p">()</span>
            <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">,:],</span> <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>
            <span class="n">g</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_goal</span><span class="p">()</span>
            <span class="n">forcing</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_forcing</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">w_p_ee</span><span class="p">[</span><span class="n">k</span><span class="p">,:],</span> <span class="n">w_q_ee</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pose</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">in_world_frame</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">time_steps</span><span class="p">,</span> <span class="n">w_p_ee</span><span class="p">,</span> <span class="n">w_q_ee</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">forcing</span><span class="p">,</span> <span class="n">s</span></div>


<div class="viewcode-block" id="Target_DMP.set_new_target_frame"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Target_DMP.set_new_target_frame">[docs]</a>    <span class="k">def</span> <span class="nf">set_new_target_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w_H_t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set new world-to-target transform</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        w_H_t : numpy.ndarray</span>
<span class="sd">            new world-to-target hom. tr. [w_H_t.shape = (4,4)]</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if w_H_t is not a proper hom. tr. matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">w_H_t</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_rotation_matrix</span><span class="p">(</span><span class="n">w_H_t</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">w_H_t</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">w_H_t</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">w_H_t</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.</span> 
                    <span class="ow">and</span> <span class="n">w_H_t</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span> 
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;w_H_t is not a proper </span><span class="se">\</span>
<span class="s1">                        homogeneous transformation matrix&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_H_t</span> <span class="o">=</span> <span class="n">w_H_t</span></div>
        

<div class="viewcode-block" id="Target_DMP.reset"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Target_DMP.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">in_world_frame</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset DMP at initial state x0.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x0 : numpy.ndarray</span>
<span class="sd">            initial state</span>

<span class="sd">        in_world_frame : bool, optional</span>
<span class="sd">            pose expressed in world frame (default is True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">in_world_frame</span><span class="p">:</span>
            <span class="n">w_position_x0</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">w_axis_angle_x0</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
            <span class="n">w_R_x0</span> <span class="o">=</span> <span class="n">axis_angle_to_rot</span><span class="p">(</span><span class="n">w_axis_angle_x0</span><span class="p">)</span>  

            <span class="c1"># world-to-x0</span>
            <span class="n">w_H_x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">w_H_x0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_R_x0</span>
            <span class="n">w_H_x0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_position_x0</span>
            <span class="n">w_H_x0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="c1"># target-to-x0</span>
            <span class="n">t_H_x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_H_t</span><span class="p">),</span> <span class="n">w_H_x0</span><span class="p">)</span>
            <span class="n">t_R_x0</span> <span class="o">=</span> <span class="n">t_H_x0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">axis</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">rot_to_axis_angle</span><span class="p">(</span><span class="n">t_R_x0</span><span class="p">,</span> <span class="n">auto_align</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
            <span class="n">t_axis_angle_x0</span> <span class="o">=</span> <span class="n">axis</span><span class="o">*</span><span class="n">angle</span>
            <span class="n">t_position_x0</span> <span class="o">=</span> <span class="n">t_H_x0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">x0_in_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
            <span class="n">x0_in_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_position_x0</span>
            <span class="n">x0_in_ref</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_axis_angle_x0</span>

            <span class="c1"># reset phase</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
             <span class="c1"># reset transformation system</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">x0_in_ref</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># reset phase</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canonical_sys</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="c1"># reset transformation system</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span></div>


<div class="viewcode-block" id="Target_DMP.set_new_goal"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Target_DMP.set_new_goal">[docs]</a>    <span class="k">def</span> <span class="nf">set_new_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_g</span><span class="p">,</span> <span class="n">force_goal</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">in_world_frame</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set new desired goal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_g : numpy.ndarray</span>
<span class="sd">            new goal</span>

<span class="sd">        force_goal : bool, optional</span>
<span class="sd">            choose if override g variable or only g0 (default is True)</span>

<span class="sd">        in_world_frame : bool, optional</span>
<span class="sd">            pose expressed in world frame (default is True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">in_world_frame</span><span class="p">:</span>
            <span class="n">w_position_g</span> <span class="o">=</span> <span class="n">new_g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">w_axis_angle_g</span> <span class="o">=</span> <span class="n">new_g</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
            <span class="n">w_R_g</span> <span class="o">=</span> <span class="n">axis_angle_to_rot</span><span class="p">(</span><span class="n">w_axis_angle_g</span><span class="p">)</span>  

            <span class="c1"># world-to-goal</span>
            <span class="n">w_H_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">w_H_g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_R_g</span>
            <span class="n">w_H_g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_position_g</span>
            <span class="n">w_H_g</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="c1"># target-to-goal</span>
            <span class="n">t_H_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_H_t</span><span class="p">),</span> <span class="n">w_H_g</span><span class="p">)</span>
            <span class="n">t_R_g</span> <span class="o">=</span> <span class="n">t_H_g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">axis</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">rot_to_axis_angle</span><span class="p">(</span><span class="n">t_R_g</span><span class="p">,</span> <span class="n">auto_align</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
            <span class="n">t_axis_angle_g</span> <span class="o">=</span> <span class="n">axis</span><span class="o">*</span><span class="n">angle</span>
            <span class="n">t_position_g</span> <span class="o">=</span> <span class="n">t_H_g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">g_in_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">new_g</span><span class="p">)</span>
            <span class="n">g_in_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_position_g</span>
            <span class="n">g_in_ref</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_axis_angle_g</span>

            <span class="c1"># update goal system</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">goal_sys</span><span class="o">.</span><span class="n">set_new_goal</span><span class="p">(</span><span class="n">g_in_ref</span><span class="p">,</span> <span class="n">force_goal</span> <span class="o">=</span> <span class="n">force_goal</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
             <span class="c1"># update goal system</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">goal_sys</span><span class="o">.</span><span class="n">set_new_goal</span><span class="p">(</span><span class="n">new_g</span><span class="p">,</span> <span class="n">force_goal</span> <span class="o">=</span> <span class="n">force_goal</span><span class="p">)</span></div>


<div class="viewcode-block" id="Target_DMP.get_goal"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Target_DMP.get_goal">[docs]</a>    <span class="k">def</span> <span class="nf">get_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_world_frame</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set new desired goal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        in_world_frame : bool, optional</span>
<span class="sd">            pose expressed in world frame (default is False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">g_in_ref</span> <span class="o">=</span> <span class="n">DMP</span><span class="o">.</span><span class="n">get_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">in_world_frame</span><span class="p">:</span>
            <span class="n">t_position_g</span> <span class="o">=</span> <span class="n">g_in_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">t_axis_angle_g</span> <span class="o">=</span> <span class="n">g_in_ref</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
            <span class="n">t_R_g</span> <span class="o">=</span> <span class="n">axis_angle_to_rot</span><span class="p">(</span><span class="n">t_axis_angle_g</span><span class="p">)</span>  

            <span class="c1"># target-to-goal</span>
            <span class="n">t_H_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">t_H_g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_R_g</span>
            <span class="n">t_H_g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_position_g</span>
            <span class="n">t_H_g</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="c1"># world-to-goal</span>
            <span class="n">w_H_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_H_t</span><span class="p">,</span> <span class="n">t_H_g</span><span class="p">)</span>
            <span class="n">w_R_g</span> <span class="o">=</span> <span class="n">w_H_g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">axis</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">rot_to_axis_angle</span><span class="p">(</span><span class="n">w_R_g</span><span class="p">,</span> <span class="n">auto_align</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
            <span class="n">w_axis_angle_g</span> <span class="o">=</span> <span class="n">axis</span><span class="o">*</span><span class="n">angle</span>
            <span class="n">w_position_g</span> <span class="o">=</span> <span class="n">w_H_g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">g_in_world</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">g_in_ref</span><span class="p">)</span>
            <span class="n">g_in_world</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_position_g</span>
            <span class="n">g_in_world</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_axis_angle_g</span>

            <span class="k">return</span> <span class="n">g_in_world</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g_in_ref</span></div></div>


<div class="viewcode-block" id="Bimanual_Target_DMP"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Bimanual_Target_DMP">[docs]</a><span class="k">class</span> <span class="nc">Bimanual_Target_DMP</span><span class="p">(</span><span class="n">Target_DMP</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class used to implement the Target-Referred (TR) Bimanual DMP</span>
<span class="sd">    that controls a virtual frame placed between the two end-effectors.</span>
<span class="sd">    Each end-effector pose is defined by a fixed rotation and variable </span>
<span class="sd">    translation from the central virtual frame. The demonstration is</span>
<span class="sd">    learned expressed in a target reference frame.</span>
<span class="sd">    Bimanual_Target_DMP extends the Target_DMP class.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    canonical_sys : dmp_lib.canonical.Canonical</span>
<span class="sd">        canonical system</span>

<span class="sd">    goal_sys : dmp_lib.goal.Goal</span>
<span class="sd">        goal system</span>

<span class="sd">    transformation_sys : dmp_lib.transformation.Transformation</span>
<span class="sd">        transformation system</span>

<span class="sd">    z : numpy.ndarray</span>
<span class="sd">        scaled velocity variable</span>

<span class="sd">    x0 : numpy.ndarray</span>
<span class="sd">        initial state</span>

<span class="sd">    sys_dim: int</span>
<span class="sd">        system dimension</span>

<span class="sd">    tau : float</span>
<span class="sd">        time scaling parameter</span>

<span class="sd">    dt : float</span>
<span class="sd">        sampling interval</span>

<span class="sd">    num_basis : int</span>
<span class="sd">        number of basis functions</span>

<span class="sd">    centers: numpy.ndarray</span>
<span class="sd">        basis function centers</span>

<span class="sd">    widths: numpy.ndarray</span>
<span class="sd">        basis function widths</span>

<span class="sd">    weights: numpy.ndarray</span>
<span class="sd">        basis function weights</span>

<span class="sd">    w_H_t : numpy.ndarray</span>
<span class="sd">        new world-to-target hom. tr. [w_H_t.shape = (4,4)]</span>

<span class="sd">    R_right : numpy.ndarray</span>
<span class="sd">        right EE rotation matrix [R_right.shape = (3,3)]</span>

<span class="sd">    R_left : numpy.ndarray</span>
<span class="sd">        left EE rotation matrix [R_left.shape = (3,3)]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_basis</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">g0</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span>
                 <span class="n">alpha_phase</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">alpha_stop</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="n">alpha_g</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                 <span class="n">K</span> <span class="o">=</span> <span class="mi">25</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;advanced&#39;</span><span class="p">,</span>
                 <span class="n">w_H_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">R_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">R_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_basis : int</span>
<span class="sd">            number of basis functions</span>

<span class="sd">        x0 : numpy.ndarray</span>
<span class="sd">            initial state</span>

<span class="sd">        g0 : numpy.ndarray</span>
<span class="sd">            goal state</span>

<span class="sd">        dt : float</span>
<span class="sd">            sampling time</span>

<span class="sd">        tau : float</span>
<span class="sd">            time scaling parameter</span>

<span class="sd">        alpha_phase : float, optional</span>
<span class="sd">            phase decay parameter (default is 25 / 3)</span>

<span class="sd">        alpha_stop : float, optional</span>
<span class="sd">            phase stop parameter (default is 0)</span>

<span class="sd">        alpha_g : float, optional</span>
<span class="sd">            goal advancement parameter (default is 25 / 2)</span>

<span class="sd">        K : float, optional</span>
<span class="sd">            stiffness parameter (default is 25**2 / 2)</span>

<span class="sd">        D : float, optional</span>
<span class="sd">            damping parameter (default is None -&gt; D = 2 * sqrt(K))</span>

<span class="sd">        style: string, optional</span>
<span class="sd">            dynamics style (default is &#39;advanced&#39;)</span>

<span class="sd">        w_H_t: numpy.ndarray, optional</span>
<span class="sd">            world-to-target hom. transformation (default is np.eye(4))</span>

<span class="sd">        R_right: numpy.ndarray, optional</span>
<span class="sd">            right EE rotation matrix (default is np.eye(3))</span>

<span class="sd">        R_left: numpy.ndarray, optional</span>
<span class="sd">            left EE rotation matrix (default is np.eye(3))</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if w_H_t is not a proper homogeneous transformation matrix</span>
<span class="sd">            if R_right or R_left are not proper rotation matrices</span>
<span class="sd">            if len(x0) is less than 7 (virtual frame prose + distance)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">x0</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;len(x0) must be at least 7 </span><span class="se">\</span>
<span class="s1">                (virtual frame prose + distance)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_rotation_matrix</span><span class="p">(</span><span class="n">R_right</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;R_right is not a rotation matrix&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_rotation_matrix</span><span class="p">(</span><span class="n">R_left</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;R_left is not a rotation matrix&#39;</span><span class="p">)</span>

        <span class="n">Target_DMP</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">num_basis</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">g0</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span>
            <span class="n">alpha_phase</span><span class="p">,</span> <span class="n">alpha_stop</span><span class="p">,</span> <span class="n">alpha_g</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">w_H_t</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">R_right</span> <span class="o">=</span> <span class="n">R_right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_left</span> <span class="o">=</span> <span class="n">R_left</span>

<div class="viewcode-block" id="Bimanual_Target_DMP.get_poses"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Bimanual_Target_DMP.get_poses">[docs]</a>    <span class="k">def</span> <span class="nf">get_poses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get end-effector positions from virtual frame pose.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list with left and right positions and quaternions </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># DMP state: virtual frame pose &amp; distance (+ others)</span>
        <span class="n">x</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>

        <span class="c1"># virtual frame pose in world frame</span>
        <span class="n">vf_position</span><span class="p">,</span> <span class="n">vf_quat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pose</span><span class="p">()</span>

        <span class="n">vf_R</span> <span class="o">=</span> <span class="n">quat_to_rot</span><span class="p">(</span><span class="n">vf_quat</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>

        <span class="c1"># world-to-virtual-frame</span>
        <span class="n">H_vf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">H_vf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">vf_R</span>
        <span class="n">H_vf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">vf_position</span>
        <span class="n">H_vf</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># virtual-frame-to-right</span>
        <span class="n">vf_H_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">vf_H_r</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_right</span>
        <span class="n">vf_H_r</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span> <span class="n">dist</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">vf_H_r</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># virtual-frame-to-left</span>
        <span class="n">vf_H_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">vf_H_l</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_left</span>
        <span class="n">vf_H_l</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dist</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">vf_H_l</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># compose transformations</span>
        <span class="n">H_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">H_vf</span><span class="p">,</span> <span class="n">vf_H_r</span><span class="p">)</span>
        <span class="n">H_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">H_vf</span><span class="p">,</span> <span class="n">vf_H_l</span><span class="p">)</span>

        <span class="n">R_r</span> <span class="o">=</span> <span class="n">H_r</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">q_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot_to_quat</span><span class="p">(</span><span class="n">R_r</span><span class="p">))</span>
        <span class="n">p_r</span> <span class="o">=</span> <span class="n">H_r</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">R_l</span> <span class="o">=</span> <span class="n">H_l</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">q_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rot_to_quat</span><span class="p">(</span><span class="n">R_l</span><span class="p">))</span>
        <span class="n">p_l</span> <span class="o">=</span> <span class="n">H_l</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">p_r</span><span class="p">,</span> <span class="n">q_r</span><span class="p">,</span> <span class="n">p_l</span><span class="p">,</span> <span class="n">q_l</span></div>

<div class="viewcode-block" id="Bimanual_Target_DMP.rollout"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Bimanual_Target_DMP.rollout">[docs]</a>    <span class="k">def</span> <span class="nf">rollout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run a DMP rollout and reset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list of numpy.array describing the bimanual rollout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        
        <span class="n">g0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_goal</span><span class="p">(</span><span class="n">in_world_frame</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>

        <span class="n">forcing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dim</span><span class="p">))</span>

        <span class="n">p_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">q_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">p_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">q_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_steps</span><span class="p">):</span>
            <span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_phase</span><span class="p">()</span>
            <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">,:],</span> <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>
            <span class="n">g</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_goal</span><span class="p">()</span>
            <span class="n">forcing</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_forcing</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">p_r</span><span class="p">[</span><span class="n">k</span><span class="p">,:],</span> <span class="n">q_r</span><span class="p">[</span><span class="n">k</span><span class="p">,:],</span> <span class="n">p_l</span><span class="p">[</span><span class="n">k</span><span class="p">,:],</span> <span class="n">q_l</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_poses</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation_sys</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">time_steps</span><span class="p">,</span> <span class="n">p_r</span><span class="p">,</span> <span class="n">q_r</span><span class="p">,</span> <span class="n">p_l</span><span class="p">,</span> <span class="n">q_l</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">forcing</span><span class="p">,</span> <span class="n">s</span></div>

<div class="viewcode-block" id="Bimanual_Target_DMP.info"><a class="viewcode-back" href="../../dmp_lib.html#dmp_lib.movement_primitives.Bimanual_Target_DMP.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return info about DMP type.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        string</span>
<span class="sd">            DMP type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;dual&#39;</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Fabio Amadio.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>